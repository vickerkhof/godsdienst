<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Religion Map</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
html, body { margin:0; padding:0; overflow:hidden; background:#f8f8f8; }
svg { width:100vw; height:100vh; display:block; cursor:grab; }
.tooltip { position:absolute; background:rgba(255,255,255,0.9); padding:5px 8px; border-radius:5px; font-size:13px; border:1px solid #ccc; pointer-events:none; }
.controls { position:absolute; top:10px; left:10px; background:rgba(255,255,255,0.9); padding:10px 15px; border-radius:10px; font-family:sans-serif; font-size:14px; pointer-events:auto; cursor:default; z-index:10; }
.controls label { display:block; }
</style>
</head>
<body> 

<div class="controls">
  <label>
    Mode:
    <select id="modeSelect">
      <option value="religion">Religion</option>
      <option value="religious">Religious</option>
      <option value="regularly">Regularly</option>
    </select>
  </label>
</div>
<div class="tooltip" style="opacity:0;"></div>

<script>
const bgWidth = 3840, bgHeight = 1918;

const colorMaps = {
  religion: { "katholiek":"#1f77b4", "niet gelovig":"#ff7f0e", "niet geintereseerd":"#2ca02c", "iets":"#d62728", default:"#cccccc" },
  religious: { yes:"#2ca02c", no:"#d62728", default:"#cccccc" },
  regularly: { yes:"#1f77b4", no:"#ff7f0e", default:"#cccccc" }
};

let currentMode = "religion";

const svg = d3.select("body").append("svg").attr("viewBox",[0,0,bgWidth,bgHeight]);
const g = svg.append("g");
g.append("image").attr("xlink:href","kepler.png").attr("x",0).attr("y",0).attr("width",bgWidth).attr("height",bgHeight);

const tooltip = d3.select(".tooltip");

d3.csv("godsdienst_pixels.csv", d => {
    // Normalize keys and values
    console.log(d);
    const cleaned = {};
    Object.keys(d).forEach(key => {
      const cleanKey = key.trim().toLowerCase();
      const val = d[key] ? d[key].trim() : "";
      cleaned[cleanKey] = val;
    });
    return {
      address: cleaned.address || "",
      religion: cleaned.religion || "default",
      x: +cleaned.x,
      y: +cleaned.y,
      religious: cleaned.religious || "no",
      regularly: cleaned.regularly || "no"
    };
}).then(data => {

  const controls = d3.select(".controls");

  const delaunay = d3.Delaunay.from(data,d=>d.x,d=>d.y);
  const voronoi = delaunay.voronoi([0,0,bgWidth,bgHeight]);

  function safeRenderCell(i){try{const path=voronoi.renderCell(i);return(!path||path.includes("NaN"))?null:path}catch{return null}}

  const cells = g.selectAll("path").data(data).join("path")
    .attr("d",(_,i)=>safeRenderCell(i))
    .attr("stroke","#333")
    .attr("stroke-width",0.3)
    .on("mousemove",(event,d)=>tooltip.style("opacity",1)
      .style("left",(event.pageX+12)+"px")
      .style("top",(event.pageY-10)+"px")
      .html(`<b>${d.religion}</b><br>${d.address}<br>Religious: ${d.religious}<br>Regular: ${d.regularly}`))
    .on("mouseout",()=>tooltip.style("opacity",0));

  const points = g.selectAll("circle").data(data).join("circle")
    .attr("cx",d=>d.x)
    .attr("cy",d=>d.y)
    .attr("stroke","#000")
    .attr("stroke-width",0.5)
    .attr("r",6);

  function buildCheckboxes() {
    controls.selectAll("label.mode-checkbox").remove();
    const values = [...new Set(data.map(d => (d[currentMode] || "").trim().toLowerCase()))].sort();
    values.forEach(v => {
      const div = controls.append("label").classed("mode-checkbox", true);
      div.append("input")
        .attr("type", "checkbox")
        .attr("checked", true)
        .attr("value", v)
        .on("change", update);
      div.append("span").text(" " + v);
    });
  }

  function update() {
    const active = new Set(d3.selectAll(".mode-checkbox input:checked").nodes().map(d => d.value.trim().toLowerCase()));
    const cmap = colorMaps[currentMode];

    cells.attr("display", d => active.has((d[currentMode] || "").trim().toLowerCase()) ? null : "none")
         .attr("fill", d => cmap[(d[currentMode] || "").trim().toLowerCase()] || cmap.default)
         .attr("fill-opacity",0.5);

    points.attr("display", d => active.has((d[currentMode] || "").trim().toLowerCase()) ? null : "none")
          .attr("fill", d => cmap[(d[currentMode] || "").trim().toLowerCase()] || cmap.default);
  }

  buildCheckboxes();
  update();

  d3.select("#modeSelect").on("change",function(){
    currentMode=this.value;
    buildCheckboxes();
    update();
  });
});

const zoom=d3.zoom().scaleExtent([1,6]).translateExtent([[0,0],[bgWidth,bgHeight]]).on("zoom",event=>g.attr("transform",event.transform));
svg.call(zoom);
</script>

</body>
</html>
