<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Religion Map</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
html, body { margin:0; padding:0; overflow:hidden; background:#f8f8f8; }
svg { width:100vw; height:100vh; display:block; cursor:grab; }
.tooltip { position:absolute; background:rgba(255,255,255,0.9); padding:5px 8px; border-radius:5px; font-size:13px; border:1px solid #ccc; pointer-events:none; }
.controls { position:absolute; top:10px; left:10px; background:rgba(255,255,255,0.9); padding:10px 15px; border-radius:10px; font-family:sans-serif; font-size:14px; pointer-events:auto; cursor:default; z-index:10; }
.controls label { display:block; margin-bottom:4px; }
.controls .sub-options { margin-top:4px; padding-left:16px; }
</style>
</head>
<body>

<div class="controls">
  <div>
    <strong>Mode:</strong>
    <div class="mode-option">
      <label><input type="radio" name="mode" value="religion" checked> Religion</label>
      <div class="sub-options"></div>
    </div>
    <div class="mode-option">
      <label><input type="radio" name="mode" value="religious"> Religious</label>
      <div class="sub-options"></div>
    </div>
    <div class="mode-option">
      <label><input type="radio" name="mode" value="regularly"> Regularly</label>
      <div class="sub-options"></div>
    </div>
  </div>
</div>

<div class="tooltip" style="opacity:0;"></div>

<script>
const bgWidth = 3840, bgHeight = 1918;

const colorMaps = {
  religion: { "katholiek":"#1f77b4", "niet gelovig":"#ff7f0e", "niet geintereseerd":"#2ca02c", "iets":"#d62728", default:"#cccccc" },
  religious: { yes:"#2ca02c", no:"#d62728", default:"#cccccc" },
  regularly: { yes:"#1f77b4", no:"#ff7f0e", default:"#cccccc" }
};

let currentMode = "religion";

const svg = d3.select("body").append("svg").attr("viewBox",[0,0,bgWidth,bgHeight]);
const g = svg.append("g");
g.append("image").attr("xlink:href","kepler.png").attr("x",0).attr("y",0).attr("width",bgWidth).attr("height",bgHeight);

const tooltip = d3.select(".tooltip");

d3.csv("godsdienst_pixels.csv", d => {
    const cleaned = {};
    Object.keys(d).forEach(key => {
      const cleanKey = key.trim().toLowerCase();
      const val = d[key] ? d[key].trim() : "";
      cleaned[cleanKey] = val;
    });
    return {
      address: cleaned.address || "",
      religion: cleaned.religion || "default",
      x: +cleaned.x,
      y: +cleaned.y,
      religious: cleaned.religious || "no",
      regularly: cleaned.regularly || "no"
    };
}).then(data => {

  const controls = d3.select(".controls");

  const delaunay = d3.Delaunay.from(data,d=>d.x,d=>d.y);
  const voronoi = delaunay.voronoi([0,0,bgWidth,bgHeight]);

  function safeRenderCell(i){try{const path=voronoi.renderCell(i);return(!path||path.includes("NaN"))?null:path}catch{return null}}

  const cells = g.selectAll("path").data(data).join("path")
    .attr("d",(_,i)=>safeRenderCell(i))
    .attr("stroke","#333")
    .attr("stroke-width",0.3)
    .on("mousemove",(event,d)=>tooltip.style("opacity",1)
      .style("left",(event.pageX+12)+"px")
      .style("top",(event.pageY-10)+"px")
      .html(`<b>${d.religion}</b><br>${d.address}<br>Religious: ${d.religious}<br>Regular: ${d.regularly}`))
    .on("mouseout",()=>tooltip.style("opacity",0));

  const points = g.selectAll("circle").data(data).join("circle")
    .attr("cx",d=>d.x)
    .attr("cy",d=>d.y)
    .attr("stroke","#000")
    .attr("stroke-width",0.5)
    .attr("r",6);

  function buildCheckboxes() {
    // Clear all sub-options
    d3.selectAll(".sub-options").selectAll("label").remove();

    // Only show sub-options under the current mode
    const subDiv = d3.select(`input[name='mode'][value='${currentMode}']`).node().closest('.mode-option');
    const subOptionsDiv = d3.select(subDiv).select(".sub-options");

    const values = [...new Set(data.map(d => (d[currentMode] || "").trim().toLowerCase()))].sort();
    values.forEach(v => {
      const label = subOptionsDiv.append("label");
      label.append("input")
        .attr("type", "checkbox")
        .attr("checked", true)
        .attr("value", v)
        .on("change", update);
      label.append("span").text(" " + v);
    });

    // Hide all other sub-options
    d3.selectAll(".mode-option .sub-options").style("display", "none");
    subOptionsDiv.style("display", "block");
  }

  function update() {
    // Get the sub-options div for the current mode
    const subDiv = d3.select(`input[name='mode'][value='${currentMode}']`).node().closest('.mode-option');
    const subOptionsDiv = d3.select(subDiv).select(".sub-options");

    const active = new Set(subOptionsDiv.selectAll("input:checked").nodes().map(d => d.value.trim().toLowerCase()));
    const cmap = colorMaps[currentMode];

    cells.attr("display", d => active.has((d[currentMode] || "").trim().toLowerCase()) ? null : "none")
         .attr("fill", d => cmap[(d[currentMode] || "").trim().toLowerCase()] || cmap.default)
         .attr("fill-opacity",0.5);

    points.attr("display", d => active.has((d[currentMode] || "").trim().toLowerCase()) ? null : "none")
          .attr("fill", d => cmap[(d[currentMode] || "").trim().toLowerCase()] || cmap.default);
  }

  buildCheckboxes();
  update();

  // Listen to radio buttons for mode change
  controls.selectAll("input[name='mode']").on("change", function() {
    currentMode = this.value;
    buildCheckboxes();
    update();
  });
});

const viewportHeight = window.innerHeight;

// max zoom so image height matches viewport height
const maxZoom = viewportHeight / bgHeight;

const zoom = d3.zoom()
  .scaleExtent([1, 6])  // Allow zooming in and out freely
  .translateExtent([[0,0],[bgWidth,bgHeight]])
  .on("zoom", event => g.attr("transform", event.transform));

svg.call(zoom);


svg.call(zoom);

</script>

</body>
</html>
